<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Toastie UTS Tool</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
      integrity="sha512-cyzxRvewl+FOKTtpBzYjW6x6IAYUCZy3sGP40hn+DQkqeluGRCax7qztK2ImL64SA+C7kVWdLI6wvdlStawhyw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      /* Top container: source image on left, room preview on right */
      #topContainer {
        display: flex;
        gap: 20px;
        align-items: flex-start;
      }
      #sourceContainer,
      #roomPreviewContainer {
        flex: 1;
      }
      /* Image preview container: position relative for arrow overlays */
      #imagePreviewContainer {
        position: relative;
        display: inline-block;
      }
      #imagePreview {
        max-width: 100%;
        max-height: 400px;
        border: 1px solid #ccc;
        display: block;
        margin-top: 10px;
      }
      /* Nudge arrow buttons (overlayed on the image preview container) */
      .nudgeArrow {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #ccc;
        cursor: pointer;
        padding: 5px;
        font-size: 16px;
      }
      #nudgeUp {
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
      }
      #nudgeDown {
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
      }
      #nudgeLeft {
        left: 5px;
        top: 50%;
        transform: translateY(-50%);
      }
      #nudgeRight {
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
      }
      /* Confirm Crop button in bottom-right corner */
      #confirmCropBtn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: lightgreen;
        border: 1px solid #ccc;
        cursor: pointer;
        padding: 5px 10px;
      }
      /* Hide nudge controls container by default */
      #nudgeControlsContainer {
        display: none;
      }
      /* Tile Table */
      #tileTable {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
      }
      #tileTable th,
      #tileTable td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
      }
      .tileCell {
        cursor: pointer;
        width: 100px;
        height: 100px;
        position: relative;
      }
      .tileCell img {
        max-width: 100%;
        max-height: 100%;
      }
      /* Room preview canvas */
      #roomPreviewCanvas {
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Toastie UTS Tool</h1>
    <!-- Top Container: Source Image & Room Preview -->
    <div id="topContainer">
      <div id="sourceContainer">
        <p>Select a sample image or upload your own:</p>
        <select id="sampleImages">
          <option value="">-- Select Sample Image --</option>
          <option value="images/sample1.png">Sample 1</option>
          <option value="images/sample2.png">Sample 2</option>
          <!-- Add more sample images as needed -->
        </select>
        <input type="file" id="uploadImage" accept="image/*">
        <div id="imagePreviewContainer">
          <img id="imagePreview" src="" alt="Source Image">
          <!-- Nudge controls overlay -->
          <div id="nudgeControlsContainer">
            <button id="nudgeUp" class="nudgeArrow">↑</button>
            <button id="nudgeDown" class="nudgeArrow">↓</button>
            <button id="nudgeLeft" class="nudgeArrow">←</button>
            <button id="nudgeRight" class="nudgeArrow">→</button>
            <button id="confirmCropBtn">Confirm Crop</button>
          </div>
        </div>
      </div>
      <div id="roomPreviewContainer">
        <h2>Room Preview</h2>
        <p>This preview simulates a continuous dungeon room built using your tile selections.</p>
        <canvas id="roomPreviewCanvas" width="500" height="500"></canvas>
      </div>
    </div>

    <!-- Tile Table -->
    <h2>Tileset Configuration</h2>
    <p>
      Click on a cell below to define a tile variant. Each row corresponds to a tile type and the columns represent different variations (default 4 per type). The first cropped variant for each tile type sets the default size; subsequent crops are scaled to match.
      Clicking an already defined tile re‑opens the crop tool with its stored crop data, or if absent, the last confirmed crop.
    </p>
    <table id="tileTable">
      <thead>
        <tr>
          <th>Tile Type</th>
          <th>Variant 1</th>
          <th>Variant 2</th>
          <th>Variant 3</th>
          <th>Variant 4</th>
        </tr>
      </thead>
      <tbody>
        <tr data-tile-type="Floor">
          <td>Floor</td>
          <td class="tileCell" data-tile-type="Floor" data-variation="1"></td>
          <td class="tileCell" data-tile-type="Floor" data-variation="2"></td>
          <td class="tileCell" data-tile-type="Floor" data-variation="3"></td>
          <td class="tileCell" data-tile-type="Floor" data-variation="4"></td>
        </tr>
        <tr data-tile-type="NorthWall">
          <td>North Wall</td>
          <td class="tileCell" data-tile-type="NorthWall" data-variation="1"></td>
          <td class="tileCell" data-tile-type="NorthWall" data-variation="2"></td>
          <td class="tileCell" data-tile-type="NorthWall" data-variation="3"></td>
          <td class="tileCell" data-tile-type="NorthWall" data-variation="4"></td>
        </tr>
        <tr data-tile-type="SouthWall">
          <td>South Wall</td>
          <td class="tileCell" data-tile-type="SouthWall" data-variation="1"></td>
          <td class="tileCell" data-tile-type="SouthWall" data-variation="2"></td>
          <td class="tileCell" data-tile-type="SouthWall" data-variation="3"></td>
          <td class="tileCell" data-tile-type="SouthWall" data-variation="4"></td>
        </tr>
        <tr data-tile-type="WestWall">
          <td>West Wall</td>
          <td class="tileCell" data-tile-type="WestWall" data-variation="1"></td>
          <td class="tileCell" data-tile-type="WestWall" data-variation="2"></td>
          <td class="tileCell" data-tile-type="WestWall" data-variation="3"></td>
          <td class="tileCell" data-tile-type="WestWall" data-variation="4"></td>
        </tr>
        <tr data-tile-type="EastWall">
          <td>East Wall</td>
          <td class="tileCell" data-tile-type="EastWall" data-variation="1"></td>
          <td class="tileCell" data-tile-type="EastWall" data-variation="2"></td>
          <td class="tileCell" data-tile-type="EastWall" data-variation="3"></td>
          <td class="tileCell" data-tile-type="EastWall" data-variation="4"></td>
        </tr>
        <tr data-tile-type="NorthwestCorner">
          <td>Northwest Corner</td>
          <td class="tileCell" data-tile-type="NorthwestCorner" data-variation="1"></td>
          <td class="tileCell" data-tile-type="NorthwestCorner" data-variation="2"></td>
          <td class="tileCell" data-tile-type="NorthwestCorner" data-variation="3"></td>
          <td class="tileCell" data-tile-type="NorthwestCorner" data-variation="4"></td>
        </tr>
        <tr data-tile-type="NortheastCorner">
          <td>Northeast Corner</td>
          <td class="tileCell" data-tile-type="NortheastCorner" data-variation="1"></td>
          <td class="tileCell" data-tile-type="NortheastCorner" data-variation="2"></td>
          <td class="tileCell" data-tile-type="NortheastCorner" data-variation="3"></td>
          <td class="tileCell" data-tile-type="NortheastCorner" data-variation="4"></td>
        </tr>
        <tr data-tile-type="SouthwestCorner">
          <td>Southwest Corner</td>
          <td class="tileCell" data-tile-type="SouthwestCorner" data-variation="1"></td>
          <td class="tileCell" data-tile-type="SouthwestCorner" data-variation="2"></td>
          <td class="tileCell" data-tile-type="SouthwestCorner" data-variation="3"></td>
          <td class="tileCell" data-tile-type="SouthwestCorner" data-variation="4"></td>
        </tr>
        <tr data-tile-type="SoutheastCorner">
          <td>Southeast Corner</td>
          <td class="tileCell" data-tile-type="SoutheastCorner" data-variation="1"></td>
          <td class="tileCell" data-tile-type="SoutheastCorner" data-variation="2"></td>
          <td class="tileCell" data-tile-type="SoutheastCorner" data-variation="3"></td>
          <td class="tileCell" data-tile-type="SoutheastCorner" data-variation="4"></td>
        </tr>
      </tbody>
    </table>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
      integrity="sha512-6lplKUSl86rUVprDIjiW8DuOniNX8UDoRATqZSds/7t6zCQZfaCe3e5zcGaQwxa8Kpn5RTM9Fvl3X2lLV4grPQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // Global state variables
      let currentImage = null;
      let cropper = null;
      let selectedTileCell = null;
      let lastCropData = null; // Last confirmed crop data
      // Global metadata: { tileType: { defaultSize: {width, height}, variations: [ ... ] } }
      window.tilesetMetadata = {};
      window.defaultTileSizes = {};

      // Elements
      const imagePreview = document.getElementById('imagePreview');
      const sampleImagesSelect = document.getElementById('sampleImages');
      const uploadImageInput = document.getElementById('uploadImage');
      const roomPreviewCanvas = document.getElementById('roomPreviewCanvas');
      const nudgeUpBtn = document.getElementById('nudgeUp');
      const nudgeDownBtn = document.getElementById('nudgeDown');
      const nudgeLeftBtn = document.getElementById('nudgeLeft');
      const nudgeRightBtn = document.getElementById('nudgeRight');
      const confirmCropBtn = document.getElementById('confirmCropBtn');
      const nudgeControlsContainer = document.getElementById('nudgeControlsContainer');

      // Load sample image from dropdown selection
      sampleImagesSelect.addEventListener('change', function() {
        if (this.value) {
          imagePreview.src = this.value;
          imagePreview.style.display = 'block';
          currentImage = imagePreview;
        }
      });

      // Load user-uploaded image
      uploadImageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            currentImage = imagePreview;
          };
          reader.readAsDataURL(file);
        }
      });

      // When a tile cell is clicked, activate crop mode on the sample image.
      document.querySelectorAll('.tileCell').forEach(cell => {
        cell.addEventListener('click', function() {
          if (cropper && selectedTileCell && selectedTileCell !== this) {
            confirmCrop(); // Auto-confirm previous selection if switching cell
          }
          selectedTileCell = this;
          openCropMode();
        });
      });

      // Open crop mode on the sample image in-place.
      function openCropMode() {
        nudgeControlsContainer.style.display = 'block';
        if (cropper) cropper.destroy();
        cropper = new Cropper(imagePreview, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 0.5,
          ready() {
            const tileType = selectedTileCell.getAttribute('data-tile-type');
            const variation = selectedTileCell.getAttribute('data-variation');
            const variantIndex = parseInt(variation) - 1;
            let storedCropData = null;
            if (
              window.tilesetMetadata[tileType] &&
              window.tilesetMetadata[tileType].variations[variantIndex] &&
              window.tilesetMetadata[tileType].variations[variantIndex].cropData
            ) {
              storedCropData = window.tilesetMetadata[tileType].variations[variantIndex].cropData;
            } else if (lastCropData) {
              storedCropData = lastCropData;
            }
            if (storedCropData) {
              cropper.setData(storedCropData);
            }
          }
        });
      }

      // Helper function to refresh the active tile preview after a nudge.
      function refreshActiveTilePreview() {
        if (cropper && selectedTileCell) {
          let canvas = cropper.getCroppedCanvas();
          const newImage = canvas.toDataURL('image/png');
          selectedTileCell.innerHTML = '<img src="' + newImage + '" alt="Tile Variant">';
          const tileType = selectedTileCell.getAttribute('data-tile-type');
          const variantIndex = parseInt(selectedTileCell.getAttribute('data-variation')) - 1;
          window.tilesetMetadata[tileType] = window.tilesetMetadata[tileType] || { variations: [] };
          window.tilesetMetadata[tileType].variations[variantIndex] = {
            variation: selectedTileCell.getAttribute('data-variation'),
            imageData: newImage,
            width: canvas.width,
            height: canvas.height,
            cropData: cropper.getData(true)
          };
          updateRoomPreview();
        }
      }

      // Nudge controls: adjust the crop box by 1 pixel increments.
      nudgeUpBtn.addEventListener('click', function() {
        if (cropper) {
          let data = cropper.getData(true);
          data.y -= 1;
          cropper.setData(data);
          refreshActiveTilePreview();
        }
      });
      nudgeDownBtn.addEventListener('click', function() {
        if (cropper) {
          let data = cropper.getData(true);
          data.y += 1;
          cropper.setData(data);
          refreshActiveTilePreview();
        }
      });
      nudgeLeftBtn.addEventListener('click', function() {
        if (cropper) {
          let data = cropper.getData(true);
          data.x -= 1;
          cropper.setData(data);
          refreshActiveTilePreview();
        }
      });
      nudgeRightBtn.addEventListener('click', function() {
        if (cropper) {
          let data = cropper.getData(true);
          data.x += 1;
          cropper.setData(data);
          refreshActiveTilePreview();
        }
      });

      // Confirm crop when user clicks the Confirm Crop button.
      confirmCropBtn.addEventListener('click', confirmCrop);

      function confirmCrop() {
        if (cropper) {
          let canvas = cropper.getCroppedCanvas();
          const tileType = selectedTileCell.getAttribute('data-tile-type');
          const cropData = cropper.getData(true);
          lastCropData = cropData;
          if (!window.defaultTileSizes[tileType]) {
            window.defaultTileSizes[tileType] = { width: canvas.width, height: canvas.height };
          } else {
            const defaultWidth = window.defaultTileSizes[tileType].width;
            const defaultHeight = window.defaultTileSizes[tileType].height;
            if (canvas.width !== defaultWidth || canvas.height !== defaultHeight) {
              const offCanvas = document.createElement('canvas');
              offCanvas.width = defaultWidth;
              offCanvas.height = defaultHeight;
              const offCtx = offCanvas.getContext('2d');
              offCtx.drawImage(canvas, 0, 0, defaultWidth, defaultHeight);
              canvas = offCanvas;
            }
          }
          const croppedDataUrl = canvas.toDataURL('image/png');
          selectedTileCell.innerHTML = '<img src="' + croppedDataUrl + '" alt="Tile Variant">';
          window.tilesetMetadata[tileType] = window.tilesetMetadata[tileType] || { variations: [] };
          const variantIndex = parseInt(selectedTileCell.getAttribute('data-variation')) - 1;
          window.tilesetMetadata[tileType].variations[variantIndex] = {
            variation: selectedTileCell.getAttribute('data-variation'),
            imageData: croppedDataUrl,
            width: canvas.width,
            height: canvas.height,
            cropData: cropData
          };
          cropper.destroy();
          cropper = null;
          nudgeControlsContainer.style.display = 'none';
          updateRoomPreview();
        }
      }

      // Update room preview using a canvas simulating a continuous roguelike room.
      function updateRoomPreview() {
        const ctx = roomPreviewCanvas.getContext('2d');
        const numRows = 5, numCols = 5;
        const tileSize = window.defaultTileSizes["Floor"]
          ? window.defaultTileSizes["Floor"].width
          : 100;
        roomPreviewCanvas.width = numCols * tileSize;
        roomPreviewCanvas.height = numRows * tileSize;
        ctx.clearRect(0, 0, roomPreviewCanvas.width, roomPreviewCanvas.height);
        for (let r = 0; r < numRows; r++) {
          for (let c = 0; c < numCols; c++) {
            let tileType = "Floor";
            if (r === 0 && c === 0) tileType = "NorthwestCorner";
            else if (r === 0 && c === numCols - 1) tileType = "NortheastCorner";
            else if (r === numRows - 1 && c === 0) tileType = "SouthwestCorner";
            else if (r === numRows - 1 && c === numCols - 1) tileType = "SoutheastCorner";
            else if (r === 0) tileType = "NorthWall";
            else if (r === numRows - 1) tileType = "SouthWall";
            else if (c === 0) tileType = "WestWall";
            else if (c === numCols - 1) tileType = "EastWall";
            const variant =
              (window.tilesetMetadata[tileType] &&
                window.tilesetMetadata[tileType].variations &&
                window.tilesetMetadata[tileType].variations[0] &&
                window.tilesetMetadata[tileType].variations[0].imageData) ||
              null;
            const x = c * tileSize;
            const y = r * tileSize;
            if (variant) {
              const img = new Image();
              img.src = variant;
              img.onload = (function(x, y) {
                return function() {
                  ctx.drawImage(this, x, y, tileSize, tileSize);
                };
              })(x, y);
            } else {
              ctx.fillStyle = "#999";
              ctx.fillRect(x, y, tileSize, tileSize);
              ctx.fillStyle = "#000";
              ctx.font = "12px Arial";
              ctx.fillText(tileType, x + 5, y + 15);
            }
          }
        }
      }

      // Optionally, auto-confirm crop if user clicks outside the image preview container and tile cells.
      document.addEventListener('click', function(e) {
        if (cropper && !e.target.closest('#imagePreviewContainer') && !e.target.closest('.tileCell')) {
          confirmCrop();
        }
      });
    </script>
  </body>
</html>
